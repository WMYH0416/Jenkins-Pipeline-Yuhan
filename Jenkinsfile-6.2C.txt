pipeline {
    agent any
    environment {
        DIRECTORY_PATH = "C:/Users/PC/Desktop/jenkinsfile"
        TESTING_ENVIRONMENT = "Testing...."
        PRODUCTION_ENVIRONMENT = "YUHAN MA"
    }
    
    stages {
        
        stage("Build"){
            steps{
                echo "Building ..."
            }
            post{
                success{
                    mail to: "wmyh0416@gmail.com",
                    subject: "Build status Email",
                    body: "Build was successful! Great job Yuhan!"
                    emailext attachLog: true, body: '', subject: '', to: 'wmyh0416@gmail.com'
                }
            }
        }
        
        stage("Test") {
            steps {
                echo "Starting Unit Test"
                retryTests("Unit")

                echo "Starting Integration Test"
                retryTests("Integration")
            }
        }
        
        stage("Code Quality Check") {
            steps {
                retry(3) {
                    echo "Checking the quality of the code"
                }
            }
            post {
                always {
                    echo "Code Quality Check stage Finished"
                }
                success {
                    echo "Successfully checked the Code Quality"
                }
                failure {
                    echo "Failed to check the Quality"
                }
            }
        }
        
        stage("Deploy") {
            steps {
                retry(3) {
                    echo "Deploying the application to testing environment: ${env.TESTING_ENVIRONMENT}"
                }
            }
            post {
                always {
                    echo "Deploy stage Finished"
                }
                success {
                    echo "Successfully Deployed"
                }
                failure {
                    echo "Failed to deploy"
                }
            }
        }
        
        stage("Approval") {
            steps {
                echo "Waiting for approval..."
                bat "timeout /t 10 /nobreak | echo"
            }
        }
        
        stage("Deploy to Production") {
            steps {
                echo "Successfully deployed the code to the production environment: ${env.PRODUCTION_ENVIRONMENT}"
            }
        }
    }
}

def retryTests(testType) {
    retry(3) {
        timeout(time: 10, unit: "SECONDS") {
            bat "timeout /t 5 /nobreak | echo Testing - ${testType}" 
        }
    }
}
